<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È¨ºÊªÖ‰πãÂàÉÔºöÁÑ°ÈôêÂüé„ÉªÊ±∫Êà∞ÁØá (Visual Fix)</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Zen+Antique+Soft&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['"Noto Serif TC"', 'serif'], zen: ['"Zen Antique Soft"', 'serif'] },
                    colors: { 'gold-accent': '#d4af37', 'demon-red': '#8a1c1c' },
                    animation: {
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'shake-hard': 'shakeHard 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'float': 'float 3s ease-in-out infinite',
                        'cursor-move': 'cursorMove 1.2s ease-in-out infinite alternate',
                        'cut-in-slide': 'cutInSlide 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards',
                        'flash-white': 'flashWhite 0.5s ease-out forwards',
                        'slash-expand': 'slashExpand 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'final-slash': 'finalSlash 0.2s cubic-bezier(0.1, 0.9, 0.2, 1) forwards',
                        'text-zoom': 'textZoom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'fly-projectile': 'flyProjectile 0.6s cubic-bezier(0.2, 0, 0.4, 1) forwards', // Slower, clearer
                        'spin-fast': 'spin 0.3s linear infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-2px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(4px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-6px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(6px, 0, 0)' }
                        },
                        shakeHard: {
                            '0%, 100%': { transform: 'translate(0, 0) rotate(0deg)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translate(-10px, -10px) rotate(-1deg)' },
                            '20%, 40%, 60%, 80%': { transform: 'translate(10px, 10px) rotate(1deg)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        cursorMove: {
                            '0%': { left: '0%' },
                            '100%': { left: '96%' } 
                        },
                        cutInSlide: {
                            '0%': { transform: 'translateX(-100%) skewX(-20deg)', opacity: '0' },
                            '100%': { transform: 'translateX(0) skewX(-20deg)', opacity: '1' }
                        },
                        flashWhite: {
                            '0%': { backgroundColor: 'white', opacity: 1 },
                            '100%': { backgroundColor: 'transparent', opacity: 0 }
                        },
                        slashExpand: {
                            '0%': { width: '0%', opacity: 0 },
                            '50%': { opacity: 1 },
                            '100%': { width: '150%', opacity: 0 }
                        },
                        finalSlash: {
                            '0%': { width: '0%', left: '0%', opacity: 0 },
                            '50%': { opacity: 1 },
                            '100%': { width: '150%', left: '-25%', opacity: 0 }
                        },
                        textZoom: {
                            '0%': { transform: 'scale(0.5)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 }
                        },
                        // FIXED: Removed w-full conflict, explicitly handled translateY center
                        flyProjectile: {
                            '0%': { left: '15%', opacity: 0, transform: 'translateY(-50%) scale(0.5)' },
                            '10%': { opacity: 1, transform: 'translateY(-50%) scale(1.5)' },
                            '80%': { opacity: 1, transform: 'translateY(-50%) scale(2)' },
                            '100%': { left: '75%', opacity: 0, transform: 'translateY(-50%) scale(3)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f0505; color: #f3f3f3; overflow: hidden; touch-action: manipulation; user-select: none; }
        
        .infinity-bg {
            background-color: #1a0b0b;
            background-image: 
                linear-gradient(30deg, #2b0e0e 12%, transparent 12.5%, transparent 87%, #2b0e0e 87.5%, #2b0e0e),
                linear-gradient(150deg, #2b0e0e 12%, transparent 12.5%, transparent 87%, #2b0e0e 87.5%, #2b0e0e);
            background-size: 40px 70px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 4px; }
        
        .hp-bar-transition { transition: width 0.3s ease-out; }
        .hp-buffer-transition { transition: width 1s ease-out 0.3s; }
        .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .text-outline { -webkit-text-stroke: 1px black; }
        
        .finish-overlay { mix-blend-mode: exclusion; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Sound Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const SoundFX = {
            init: () => { if (audioCtx.state === 'suspended') audioCtx.resume(); },
            playTone: (freq, type, duration, vol = 0.1, slideTo = null) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, audioCtx.currentTime + duration);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            playNoise: (duration, vol = 0.1) => {
                const bufferSize = audioCtx.sampleRate * duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                noise.connect(gain);
                gain.connect(audioCtx.destination);
                noise.start();
            },
            select: () => SoundFX.playTone(800, 'sine', 0.1, 0.05),
            clash: () => { SoundFX.playNoise(0.1, 0.2); SoundFX.playTone(300, 'square', 0.1, 0.1, 100); },
            slashLight: () => { SoundFX.playNoise(0.2, 0.15); SoundFX.playTone(600, 'sawtooth', 0.15, 0.05, 1200); },
            slashHeavy: () => { SoundFX.playNoise(0.4, 0.4); SoundFX.playTone(100, 'square', 0.5, 0.4, 50); }, 
            breath: () => { SoundFX.playNoise(0.6, 0.2); SoundFX.playTone(300, 'sine', 0.6, 0.1); }, 
            charge: () => { SoundFX.playTone(100, 'sine', 0.5, 0.1, 800); },
            ultimateBoom: () => { SoundFX.playNoise(1.5, 0.5); SoundFX.playTone(50, 'sawtooth', 1.0, 0.5, 10); },
            finalKill: () => { 
                 SoundFX.playNoise(0.1, 0.5); 
                 SoundFX.playTone(1000, 'square', 0.1, 0.3); 
                 setTimeout(() => {
                     SoundFX.playNoise(2.0, 0.5); 
                     SoundFX.playTone(40, 'sawtooth', 2.0, 0.5);
                 }, 100);
            },
            guard: (perfect) => {
                if(perfect) SoundFX.playTone(1200, 'sine', 0.3, 0.2); 
                else SoundFX.playTone(200, 'square', 0.1, 0.1);
            }
        };

        const optimize = (url, width = 500) => `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=${width}&output=webp&q=75`;
        const COVER_IMAGE = optimize("https://imgtolinkx.com/i/ZmetzPkT", 600);

        const CHARACTERS = [
            { id: 'rengoku', name: 'ÁÖâÁçÑ ÊùèÂ£ΩÈÉé', title: 'ÁÇéÊü±', role: 'Slayer', color: 'bg-orange-600', hp_max: 1300, img: 'https://imgtolinkx.com/i/dIlEEyjS' },
            { id: 'giyu', name: 'ÂØåÂ≤° Áæ©Âãá', title: 'Ê∞¥Êü±', role: 'Slayer', color: 'bg-blue-600', hp_max: 1200, img: 'https://imgtolinkx.com/i/2OGqcp85' },
            { id: 'muichiro', name: 'ÊôÇÈÄè ÁÑ°‰∏ÄÈÉé', title: 'ÈúûÊü±', role: 'Slayer', color: 'bg-teal-400', hp_max: 1000, img: 'https://imgtolinkx.com/i/1Q8IEChJ' },
            { id: 'shinobu', name: 'ËÉ°Ëù∂ Âøç', title: 'Ëü≤Êü±', role: 'Slayer', color: 'bg-purple-500', hp_max: 900, img: 'https://imgtolinkx.com/i/cxBQPSbf' },
            { id: 'tanjiro', name: 'Á´àÈñÄ ÁÇ≠Ê≤ªÈÉé', title: 'Êó•‰πãÂëºÂê∏', role: 'Slayer', color: 'bg-red-700', hp_max: 1250, img: 'https://imgtolinkx.com/i/uemH1kNX' },
            { id: 'zenitsu', name: 'ÊàëÂ¶ª ÂñÑÈÄ∏', title: 'Èõ∑‰πãÂëºÂê∏', role: 'Slayer', color: 'bg-yellow-500', hp_max: 1100, img: 'https://imgtolinkx.com/i/6ORGIjDh' },
            { id: 'kokushibo', name: 'ÈªëÊ≠ªÁâü', title: '‰∏äÂº¶‰πãÂ£π', role: 'UpperMoon', color: 'bg-red-900', hp_max: 1800, img: 'https://imgtolinkx.com/i/hsmEAMsS' },
            { id: 'akaza', name: 'ÁåóÁ™©Â∫ß', title: '‰∏äÂº¶‰πãÂèÉ', role: 'UpperMoon', color: 'bg-pink-600', hp_max: 1600, img: 'https://imgtolinkx.com/i/pclB42LQ' },
            { id: 'muzan', name: 'È¨ºËàûËæª ÁÑ°ÊÖò', title: 'È¨ºÁéã', role: 'Hidden', color: 'bg-gray-900', hp_max: 2500, img: 'https://imgtolinkx.com/i/xMTvN0Wz' }
        ].map(char => ({ ...char, optimizedImg: optimize(char.img, 500) }));

        // --- Action Cut-In Component ---
        const ActionCutIn = ({ action }) => {
            if (!action) return null;
            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none overflow-hidden">
                    <div className="absolute w-[200%] h-2 bg-white shadow-[0_0_30px_white] rotate-[-45deg] animate-slash-expand origin-left"></div>
                    <div className="relative z-10 text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 animate-text-zoom text-outline drop-shadow-2xl italic font-zen" 
                         style={{textShadow: '0 0 40px rgba(255,255,255,1)'}}>
                        {action.name}
                    </div>
                </div>
            );
        };

        // --- FIXED: Projectile FX Component ---
        const ProjectileFX = ({ type }) => {
            if (!type) return null;
            
            const getVisual = () => {
                switch(type) {
                    case 'LIGHT': 
                        return (
                            <div className="relative">
                                {/* Main Blade */}
                                <div className="text-[150px] animate-spin-fast drop-shadow-[0_0_20px_cyan] filter brightness-150">‚öîÔ∏è</div>
                                {/* Trail */}
                                <div className="absolute inset-0 bg-blue-400 opacity-50 blur-xl rounded-full animate-pulse scale-150"></div>
                            </div>
                        );
                    case 'HEAVY': 
                        return (
                            <div className="relative">
                                {/* Core Fire */}
                                <div className="text-[180px] animate-spin drop-shadow-[0_0_40px_orange] filter contrast-150">üî•</div>
                                {/* Explosion Aura */}
                                <div className="absolute inset-0 bg-red-500 opacity-40 blur-2xl rounded-full animate-pulse scale-125"></div>
                            </div>
                        );
                    case 'BREATH': 
                        return (
                            <div className="relative">
                                <div className="text-[160px] opacity-90 blur-sm scale-150 drop-shadow-[0_0_30px_white]">üí®</div>
                                <div className="absolute inset-0 bg-white opacity-30 blur-3xl animate-pulse scale-150"></div>
                            </div>
                        );
                    default: return null;
                }
            };

            // Fixed positioning: Removed w-full conflict, using independent coordinate system
            return (
                <div className="fixed inset-0 z-50 pointer-events-none">
                     <div className="absolute top-1/2 animate-fly-projectile flex items-center justify-center">
                        {getVisual()}
                    </div>
                </div>
            );
        };

        const FinalMomentFX = ({ isActive }) => {
            if (!isActive) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center overflow-hidden bg-black/20 pointer-events-none">
                    <div className="absolute inset-0 bg-black animate-[flashWhite_0.1s_reverse_forwards]"></div>
                    <div className="absolute w-[200%] h-4 bg-white rotate-[-30deg] animate-final-slash shadow-[0_0_50px_white] z-20"></div>
                    <div className="absolute inset-0 bg-white mix-blend-overlay animate-flash-white z-30"></div>
                </div>
            );
        };

        // --- HUD ---
        const HUD = ({ pChar, eChar, pHp, eHp, pMax, eMax, pQi, eQi }) => {
            const pPct = Math.max(0, (pHp / pMax) * 100);
            const ePct = Math.max(0, (eHp / eMax) * 100);
            return (
                <div className="absolute top-0 left-0 w-full p-2 z-20 flex justify-between items-start gap-2 md:gap-4 bg-gradient-to-b from-black/90 to-transparent pb-8 font-serif">
                    <div className="flex-1 flex flex-col items-start relative">
                        <div className="flex items-end gap-2 mb-1 w-full pl-1">
                            <div className="text-white font-bold leading-none mb-1 text-base md:text-lg tracking-widest text-shadow">{pChar.name}</div>
                        </div>
                        <div className="w-full h-3 md:h-4 bg-gray-900 border border-gray-600 transform -skew-x-12 relative overflow-hidden shadow-lg">
                            <div className="absolute right-0 top-0 h-full bg-white/80 hp-buffer-transition" style={{width: `${pPct}%`}}></div>
                            <div className="absolute left-0 top-0 h-full bg-gradient-to-r from-yellow-600 to-yellow-400 hp-bar-transition" style={{width: `${pPct}%`}}></div>
                        </div>
                        <div className="w-3/4 h-1.5 md:h-2 mt-1 bg-gray-900 transform -skew-x-12 relative overflow-hidden border border-gray-700">
                             <div className={`absolute left-0 top-0 h-full transition-all duration-300 ${pQi >= 100 ? 'bg-blue-400 animate-pulse' : 'bg-blue-600'}`} style={{width: `${pQi}%`}}></div>
                        </div>
                    </div>
                    <div className="text-red-900/50 font-black text-2xl italic pt-2">VS</div>
                    <div className="flex-1 flex flex-col items-end relative">
                        <div className="flex items-end flex-row-reverse gap-2 mb-1 w-full pr-1">
                            <div className="text-white font-bold leading-none mb-1 text-base md:text-lg tracking-widest text-shadow">{eChar.name}</div>
                        </div>
                        <div className="w-full h-3 md:h-4 bg-gray-900 border border-gray-600 transform skew-x-12 relative overflow-hidden shadow-lg">
                            <div className="absolute left-0 top-0 h-full bg-white/80 hp-buffer-transition" style={{width: `${ePct}%`}}></div>
                            <div className="absolute right-0 top-0 h-full bg-gradient-to-l from-red-600 to-red-400 hp-bar-transition" style={{width: `${ePct}%`}}></div>
                        </div>
                         <div className="w-3/4 h-1.5 md:h-2 mt-1 bg-gray-900 transform skew-x-12 relative overflow-hidden border border-gray-700">
                             <div className={`absolute right-0 top-0 h-full transition-all duration-300 ${eQi >= 100 ? 'bg-purple-400 animate-pulse' : 'bg-purple-600'}`} style={{width: `${eQi}%`}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const DefenseQTE = ({ onComplete }) => {
            const cursorRef = useRef(null);
            const containerRef = useRef(null);
            const [result, setResult] = useState(null);

            const handlePress = () => {
                if (result) return;
                const container = containerRef.current.getBoundingClientRect();
                const cursor = cursorRef.current.getBoundingClientRect();
                const containerCenter = container.left + container.width / 2;
                const cursorCenter = cursor.left + cursor.width / 2;
                const diff = Math.abs(containerCenter - cursorCenter);
                
                let res = 'MISS';
                if (diff < 20) res = 'PERFECT';
                else if (diff < 60) res = 'GOOD';
                
                setResult(res);
                SoundFX.guard(res === 'PERFECT');
                setTimeout(() => onComplete(res), 1000);
            };

            return (
                <div className="absolute bottom-1/4 left-0 w-full flex flex-col items-center justify-center z-40 px-6 font-serif">
                    <div className="text-xl font-bold text-gold-accent mb-2 animate-pulse drop-shadow-md">Èò≤Á¶¶Ê∫ñÂÇôÔºÅ</div>
                    <div ref={containerRef} className="relative w-full max-w-md h-8 bg-black/60 rounded-full overflow-hidden border-2 border-gray-600 backdrop-blur-sm">
                        <div className="absolute left-1/2 top-0 h-full w-[120px] bg-yellow-900/50 -translate-x-1/2"></div>
                        <div className="absolute left-1/2 top-0 h-full w-[40px] bg-red-600 -translate-x-1/2 animate-pulse"></div>
                        <div ref={cursorRef} className={`absolute top-0 w-2 h-full bg-white shadow-[0_0_10px_white] ${!result ? 'animate-cursor-move' : ''}`} style={result ? {left: cursorRef.current.style.left} : {}}></div>
                    </div>
                    {result && <div className={`mt-4 text-4xl font-black italic tracking-widest ${result === 'PERFECT' ? 'text-yellow-400' : result === 'GOOD' ? 'text-blue-300' : 'text-gray-500'}`}>{result}!</div>}
                    {!result && (
                        <button onMouseDown={handlePress} onTouchStart={handlePress} className="mt-6 w-20 h-20 rounded-full bg-gray-900 border-2 border-gold-accent flex items-center justify-center active:scale-95 transition-transform shadow-[0_0_15px_rgba(212,175,55,0.3)]">
                            <span className="text-3xl">üõ°Ô∏è</span>
                        </button>
                    )}
                </div>
            );
        };

        const UltimateCutIn = ({ char }) => {
            return (
                <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center overflow-hidden font-serif">
                    <div className="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] animate-pulse"></div>
                    <div className="absolute w-[200%] h-[200%] bg-gradient-to-r from-transparent via-white/10 to-transparent rotate-45 animate-slash-line"></div>
                    <div className="relative w-full h-full max-w-2xl animate-cut-in-slide flex items-center justify-center">
                        <div className={`absolute inset-0 ${char.color} opacity-80 skew-x-[-20deg] border-l-8 border-white mix-blend-screen animate-pulse`}></div>
                        <img src={char.optimizedImg} className="absolute bottom-0 right-0 h-[120%] object-contain drop-shadow-[0_0_50px_rgba(255,255,255,0.8)] z-10 brightness-110" />
                        <h1 className="absolute top-1/3 left-10 text-7xl md:text-9xl font-black text-white italic z-20 animate-shake" style={{textShadow: '5px 5px 0px black'}}>
                            Â•ßÁæ©<br/>Ë¶∫ÈÜí
                        </h1>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('MENU');
            const [playerChar, setPlayerChar] = useState(null);
            const [enemyChar, setEnemyChar] = useState(null);
            const [playerHP, setPlayerHP] = useState(0);
            const [enemyHP, setEnemyHP] = useState(0);
            const [playerQi, setPlayerQi] = useState(0);
            const [enemyQi, setEnemyQi] = useState(0);
            
            // Combat UI States
            const [rpsResult, setRpsResult] = useState(null); 
            const [log, setLog] = useState("");
            
            // FX States
            const [showUltimate, setShowUltimate] = useState(false);
            const [screenShake, setScreenShake] = useState(false);
            const [flash, setFlash] = useState(false);
            
            // NEW FX States
            const [currentAction, setCurrentAction] = useState(null); 
            const [projectile, setProjectile] = useState(null); 
            const [isFinishing, setIsFinishing] = useState(false);

            const [loadedCount, setLoadedCount] = useState(0);

            useEffect(() => {
                const handleLoad = () => setLoadedCount(prev => prev + 1);
                const cover = new Image(); cover.src = COVER_IMAGE; cover.onload = handleLoad; cover.onerror = handleLoad;
                CHARACTERS.forEach(char => {
                    const img = new Image(); img.src = char.optimizedImg; img.onload = handleLoad; img.onerror = handleLoad;
                });
            }, []);
            const loadingProgress = Math.min(100, Math.round((loadedCount / (CHARACTERS.length + 1)) * 100));

            const startGame = () => { SoundFX.init(); setGameState('SELECT_PLAYER'); }
            const selectPlayer = (char) => { setPlayerChar(char); setGameState('SELECT_ENEMY'); };
            const selectEnemy = (enemy) => {
                setEnemyChar(enemy); 
                setPlayerHP(playerChar.hp_max); 
                setEnemyHP(enemy.hp_max);
                setPlayerQi(20); setEnemyQi(20); 
                setLog(`ÈÅ≠ÈÅá ${enemy.name}ÔºÅÊà∞È¨•ÈñãÂßãÔºÅ`);
                setRpsResult(null); setGameState('COMBAT_RPS');
                setIsFinishing(false);
            };

            const handleRPS = (choice) => { 
                SoundFX.select();
                const cpuChoice = Math.floor(Math.random() * 3);
                const rpsMap = ['‚úä', 'üñêÔ∏è', '‚úåÔ∏è'];
                setLog(`‰Ω†:${rpsMap[choice]} vs È¨º:${rpsMap[cpuChoice]}`);
                const resultVal = (choice - cpuChoice + 3) % 3;

                if (resultVal === 0) {
                    SoundFX.clash(); setRpsResult('DRAW'); setScreenShake(true);
                    setTimeout(() => { setScreenShake(false); setRpsResult(null); }, 600);
                } else if (resultVal === 1) {
                    SoundFX.select(); setTimeout(() => setGameState('COMBAT_ATTACK'), 500);
                } else {
                    setTimeout(() => setGameState('COMBAT_DEFENSE'), 500);
                }
            };

            const triggerFinishSequence = (isVictory) => {
                setIsFinishing(true);
                SoundFX.finalKill(); 
                
                setTimeout(() => {
                    setScreenShake(true); 
                    setFlash(true); 
                }, 200);

                setTimeout(() => {
                    setScreenShake(false);
                    setFlash(false);
                    setIsFinishing(false);
                    setGameState(isVictory ? 'VICTORY' : 'DEFEAT');
                }, 1500);
            };

            const handleAttack = (type) => {
                let dmg = 0; let qiGain = 0; let actionName = ""; let soundFn = null;

                if (type === 'LIGHT') {
                    dmg = 80 + Math.random() * 40; qiGain = 15; actionName = "Â£π‰πãÂûã„ÉªËøÖ";
                    soundFn = SoundFX.slashLight;
                } else if (type === 'HEAVY') {
                    dmg = 150 + Math.random() * 50; setPlayerQi(q => Math.max(0, q - 20));
                    qiGain = 5; actionName = "Ë≤≥‰πãÂûã„ÉªÁÉà";
                    soundFn = SoundFX.slashHeavy;
                } else if (type === 'BREATH') {
                    dmg = 20; qiGain = 40; actionName = "ÂÖ®ÈõÜ‰∏≠„ÉªÂ∏∏‰∏≠";
                    soundFn = SoundFX.breath;
                } else if (type === 'ULTIMATE') {
                    SoundFX.charge();
                    setShowUltimate(true);
                    setTimeout(() => {
                        SoundFX.ultimateBoom();
                        setShowUltimate(false);
                        setFlash(true);
                        setScreenShake(true);
                        applyDamageToEnemy(600);
                        setPlayerQi(0);
                        setTimeout(() => { setFlash(false); setScreenShake(false); endTurn(); }, 1200);
                    }, 2500);
                    return;
                }

                setPlayerQi(q => Math.min(100, q + qiGain));

                setCurrentAction({ name: actionName, type });
                soundFn();
                
                setTimeout(() => {
                    setCurrentAction(null);
                    setProjectile(type); 

                    setTimeout(() => {
                        setProjectile(null);
                        if (type === 'HEAVY') {
                            setScreenShake(true); 
                            setTimeout(() => setScreenShake(false), 300);
                        }
                        applyDamageToEnemy(dmg);
                        setLog(`${actionName} ÂëΩ‰∏≠ÔºÅ`);
                        
                        setTimeout(endTurn, 500);
                    }, 600); // Wait for projectile animation

                }, 400); 
            };

            const applyDamageToEnemy = (amount) => {
                const newHp = Math.max(0, Math.floor(enemyHP - amount));
                setEnemyHP(newHp);
                if (newHp <= 0) {
                    triggerFinishSequence(true);
                }
            };

            const handleDefenseComplete = (result) => {
                const baseDmg = 150 + Math.random() * 50;
                let finalDmg = baseDmg;
                let msg = "";
                if (result === 'PERFECT') {
                    finalDmg = 0; msg = "ÂÆåÁæéÈò≤Á¶¶ÔºÅ"; setPlayerQi(q => Math.min(100, q + 30));
                } else if (result === 'GOOD') {
                    finalDmg *= 0.3; msg = "Ê∏õËºïÂÇ∑ÂÆ≥ÔºÅ"; setPlayerQi(q => Math.min(100, q + 10));
                } else {
                    msg = "ÂèóÂà∞ÈáçÂâµÔºÅ"; setScreenShake(true); SoundFX.slashHeavy(); setTimeout(() => setScreenShake(false), 500);
                }
                
                const newHp = Math.max(0, Math.floor(playerHP - finalDmg));
                setPlayerHP(newHp);
                setLog(msg);
                
                if (newHp <= 0) {
                    triggerFinishSequence(false);
                } else {
                    setTimeout(endTurn, 1000);
                }
            };

            const endTurn = () => {
                if (enemyHP <= 0 || playerHP <= 0) return; 
                setEnemyQi(q => Math.min(100, q + 10));
                setRpsResult(null);
                setGameState('COMBAT_RPS');
            };

            // --- UI Rendering ---
            if (gameState === 'MENU') {
                return (
                    <div className="min-h-[100dvh] infinity-bg flex flex-col items-center justify-center p-6 relative font-serif text-center">
                        <div className="z-10 animate-float w-full max-w-md">
                            <img src={COVER_IMAGE} alt="È¨ºÊªÖ‰πãÂàÉÁÑ°ÈôêÂüé" className="w-full h-auto rounded-lg shadow-2xl mb-8 border border-white/20" />
                            <div className="mb-4">
                                <div className="text-gold-accent text-sm mb-1">Ë≥áÊ∫êËºâÂÖ•‰∏≠... {loadingProgress}%</div>
                                <div className="w-full h-2 bg-gray-900 rounded-full overflow-hidden border border-gray-700">
                                    <div className="h-full bg-red-600 transition-all duration-300" style={{width: `${loadingProgress}%`}}></div>
                                </div>
                            </div>
                            <button onClick={startGame} disabled={loadingProgress < 100} className={`px-12 py-3 border rounded text-xl font-bold transition-all shadow-[0_0_20px_rgba(220,38,38,0.6)] text-white ${loadingProgress >= 100 ? 'bg-red-900/90 border-red-500 hover:scale-105 cursor-pointer' : 'bg-gray-800 border-gray-600 opacity-50 cursor-not-allowed'}`}>{loadingProgress >= 100 ? 'ÊãîÂàÄ (ÈñãÂßã)' : 'Ê∫ñÂÇô‰∏≠...'}</button>
                        </div>
                    </div>
                );
            }
            if (gameState === 'SELECT_PLAYER') {
                return (
                    <div className="h-[100dvh] infinity-bg p-4 flex flex-col font-serif">
                        <h2 className="text-2xl font-bold text-center mb-4 text-gold-accent mt-2 shrink-0">ÈÅ∏Êìá‰Ω†ÁöÑÂäçÂ£´</h2>
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 pb-4 max-w-5xl mx-auto w-full custom-scrollbar px-1 min-h-0">
                            {CHARACTERS.filter(c => c.role === 'Slayer').map(char => (
                                <button key={char.id} onClick={() => selectPlayer(char)} className="relative group overflow-hidden rounded-lg border border-gray-700 hover:border-white transition-all bg-black h-auto flex flex-col shadow-lg">
                                    <div className="w-full aspect-[3/5] overflow-hidden relative">
                                        <div className={`absolute inset-0 ${char.color} opacity-20 z-0`}></div>
                                        <img src={char.optimizedImg} alt={char.name} className="absolute inset-0 w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-500 z-10" />
                                        <div className="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent p-3 pt-10 text-left z-20">
                                            <div className="text-xs text-gray-300 opacity-90 mb-0.5">{char.title}</div>
                                            <div className="text-lg font-bold text-white leading-tight drop-shadow-md">{char.name}</div>
                                            <div className="text-gold-accent font-mono text-[10px] opacity-90 mt-1">HP {char.hp_max}</div>
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setGameState('MENU')} className="mt-4 py-4 text-gray-500 hover:text-white transition-colors shrink-0">ËøîÂõûÊ®ôÈ°å</button>
                    </div>
                );
            }
            if (gameState === 'SELECT_ENEMY') {
                return (
                    <div className="h-[100dvh] infinity-bg p-4 flex flex-col font-serif">
                        <h2 className="text-2xl font-bold text-center mb-4 text-red-500 mt-2 shrink-0">ÈÅ∏ÊìáÂ∞çÊà∞È¨ºÊúà</h2>
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 pb-4 max-w-5xl mx-auto w-full custom-scrollbar px-1 min-h-0">
                            {CHARACTERS.filter(c => c.role === 'UpperMoon' || c.role === 'Hidden').map(char => (
                                <button key={char.id} onClick={() => selectEnemy(char)} className="relative group overflow-hidden rounded-lg border-2 border-red-900/50 hover:border-red-500 transition-all bg-black/60 h-auto flex flex-col shadow-lg">
                                    <div className="w-full aspect-[2/3] overflow-hidden relative">
                                        <img src={char.optimizedImg} alt={char.name} className="w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-500" />
                                    </div>
                                    <div className="w-full bg-gradient-to-r from-gray-900 to-black p-2 text-left border-t border-red-900/30">
                                        <div className="text-xs text-red-400 mb-0.5">{char.title}</div>
                                        <div className="text-base font-bold text-white leading-tight">{char.name}</div>
                                        <div className="text-red-500 font-mono text-[10px] opacity-70 mt-1">HP {char.hp_max}</div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setGameState('SELECT_PLAYER')} className="mt-4 py-4 text-gray-500 hover:text-white transition-colors shrink-0">ËøîÂõû‰∏ä‰∏ÄÊ≠•</button>
                    </div>
                );
            }

            if (gameState.startsWith('COMBAT') || gameState === 'VICTORY' || gameState === 'DEFEAT') {
                const isRPS = gameState === 'COMBAT_RPS';
                const isAttack = gameState === 'COMBAT_ATTACK';
                const isDefense = gameState === 'COMBAT_DEFENSE';

                return (
                    <div className={`h-[100dvh] w-full infinity-bg relative overflow-hidden font-serif ${screenShake ? 'animate-shake-hard' : ''}`}>
                        {/* Layers: FX > HUD > Chars > Controls */}
                        {showUltimate && <UltimateCutIn char={playerChar} />}
                        <ActionCutIn action={currentAction} />
                        <ProjectileFX type={projectile} />
                        <FinalMomentFX isActive={isFinishing} />
                        {flash && <div className="fixed inset-0 bg-white animate-flash-white z-[90] pointer-events-none"></div>}

                        <HUD pChar={playerChar} eChar={enemyChar} pHp={playerHP} eHp={enemyHP} pMax={playerChar.hp_max} eMax={enemyChar.hp_max} pQi={playerQi} eQi={enemyQi} />

                        <div className="absolute top-1/2 left-0 w-full -translate-y-1/2 flex justify-between px-2 md:px-20 items-end pointer-events-none z-10">
                            <div className={`relative w-40 md:w-64 transition-transform duration-500 ${isAttack ? 'translate-x-20 scale-110' : ''} ${isDefense ? 'brightness-75' : ''}`}>
                                <img src={playerChar.optimizedImg} className="w-full drop-shadow-[0_0_15px_rgba(0,0,0,0.8)]" />
                                {playerQi >= 100 && <div className="absolute inset-0 border-2 border-gold-accent animate-pulse rounded-lg opacity-50"></div>}
                            </div>
                            <div className={`relative w-40 md:w-64 transition-transform duration-500 ${isDefense ? '-translate-x-20 scale-110' : ''} ${isAttack ? 'brightness-75 grayscale-[0.5]' : ''}`}>
                                <img src={enemyChar.optimizedImg} className="w-full drop-shadow-[0_0_15px_rgba(255,0,0,0.4)] scale-x-[-1]" />
                                {gameState === 'COMBAT_DEFENSE' && <div className="absolute -top-10 left-1/2 -translate-x-1/2 text-4xl animate-bounce">‚ö†Ô∏è</div>}
                            </div>
                        </div>

                        <div className="absolute bottom-0 w-full h-1/3 bg-gradient-to-t from-black via-black/90 to-transparent z-30 flex flex-col items-center justify-end pb-6">
                            <div className="mb-4 text-gold-accent font-bold text-lg text-shadow animate-pulse">{log}</div>

                            {isRPS && (
                                <div className={`flex gap-4 transition-all duration-200 ${rpsResult === 'DRAW' ? 'scale-110 animate-shake' : ''}`}>
                                    {['‚úä', 'üñêÔ∏è', '‚úåÔ∏è'].map((sign, idx) => (
                                        <button key={idx} onClick={() => handleRPS(idx)} className="w-20 h-20 rounded-full bg-gray-800 border-2 border-gray-600 text-4xl hover:scale-110 hover:border-gold-accent transition-all shadow-lg active:scale-95">
                                            {sign}
                                        </button>
                                    ))}
                                </div>
                            )}

                            {isAttack && (
                                <div className="grid grid-cols-4 gap-2 px-4 w-full max-w-xl">
                                    <button onClick={() => handleAttack('LIGHT')} className="bg-blue-900/60 border border-blue-500 p-2 rounded text-gray-200 hover:bg-blue-800 flex flex-col items-center justify-center active:scale-95">
                                        <div className="text-2xl">üó°Ô∏è</div><div className="text-[10px]">Êñ¨Êìä</div>
                                    </button>
                                    <button disabled={playerQi < 20} onClick={() => handleAttack('HEAVY')} className="bg-red-900/60 border border-red-500 p-2 rounded text-gray-200 hover:bg-red-800 disabled:opacity-30 disabled:grayscale flex flex-col items-center justify-center active:scale-95">
                                        <div className="text-2xl">üí•</div><div className="text-[10px]">ÈáçÊìä</div>
                                    </button>
                                    <button onClick={() => handleAttack('BREATH')} className="bg-green-900/60 border border-green-500 p-2 rounded text-gray-200 hover:bg-green-800 flex flex-col items-center justify-center active:scale-95">
                                        <div className="text-2xl">üí®</div><div className="text-[10px]">ÂëºÂê∏</div>
                                    </button>
                                    <button disabled={playerQi < 100} onClick={() => handleAttack('ULTIMATE')} className={`col-span-1 border p-2 rounded text-white transition-all flex flex-col items-center justify-center active:scale-95 ${playerQi >= 100 ? 'bg-red-700 border-red-400 animate-pulse shadow-[0_0_15px_rgba(220,38,38,0.6)]' : 'bg-gray-800 border-gray-600 opacity-30'}`}>
                                        <div className="text-2xl">üî•</div><div className="text-[10px] font-bold">Â•ßÁæ©</div>
                                    </button>
                                </div>
                            )}

                            {isDefense && <DefenseQTE onComplete={handleDefenseComplete} />}

                            {(gameState === 'VICTORY' || gameState === 'DEFEAT') && !isFinishing && (
                                <div className="text-center animate-float z-50">
                                    <h2 className={`text-6xl font-black mb-4 drop-shadow-xl ${gameState === 'VICTORY' ? 'text-gold-accent' : 'text-gray-500'}`}>
                                        {gameState === 'VICTORY' ? 'ÊÉ°È¨ºÊªÖÊÆ∫' : 'ÂãùË≤†Â∑≤ÂàÜ'}
                                    </h2>
                                    <button onClick={() => setGameState('MENU')} className="px-8 py-2 border border-white text-white hover:bg-white hover:text-black transition-colors">
                                        ËøîÂõû‰∏ªÈÅ∏ÂñÆ
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
