<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>é¬¼æ»…ä¹‹åˆƒï¼šç„¡é™åŸãƒ»æ±ºæˆ°ç¯‡</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['"Noto Serif TC"', 'serif'] },
                    colors: { 'gold-accent': '#d4af37' },
                    animation: {
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'slash': 'slash 0.2s ease-out forwards',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        // æ–°å¢é£›è¡Œç‰¹æ•ˆå‹•ç•«
                        'fly-p-desktop': 'flyRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'fly-e-desktop': 'flyLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'fly-p-mobile': 'flyUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'fly-e-mobile': 'flyDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'spin': 'spin 0.5s linear infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-2px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(4px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-8px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(8px, 0, 0)' }
                        },
                        slash: {
                            '0%': { transform: 'scale(1) rotate(-45deg)', opacity: '0.8', filter: 'brightness(2)' },
                            '50%': { transform: 'scale(1.5) rotate(-45deg)', opacity: '1' },
                            '100%': { transform: 'scale(2) rotate(-45deg)', opacity: '0' }
                        },
                        flyRight: {
                            '0%': { transform: 'translateX(0) scale(0.5)', opacity: '0' },
                            '20%': { opacity: '1' },
                            '100%': { transform: 'translateX(300px) scale(1.5)', opacity: '0' }
                        },
                        flyLeft: {
                            '0%': { transform: 'translateX(0) scale(0.5)', opacity: '0' },
                            '20%': { opacity: '1' },
                            '100%': { transform: 'translateX(-300px) scale(1.5)', opacity: '0' }
                        },
                        flyUp: {
                            '0%': { transform: 'translateY(0) scale(0.5)', opacity: '0' },
                            '20%': { opacity: '1' },
                            '100%': { transform: 'translateY(-250px) scale(1.5)', opacity: '0' }
                        },
                        flyDown: {
                            '0%': { transform: 'translateY(0) scale(0.5)', opacity: '0' },
                            '20%': { opacity: '1' },
                            '100%': { transform: 'translateY(250px) scale(1.5)', opacity: '0' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f0505; color: #f3f3f3; overflow: hidden; touch-action: manipulation; }
        .infinity-bg {
            background-color: #1a0b0b;
            background-image: 
                linear-gradient(30deg, #2b0e0e 12%, transparent 12.5%, transparent 87%, #2b0e0e 87.5%, #2b0e0e),
                linear-gradient(150deg, #2b0e0e 12%, transparent 12.5%, transparent 87%, #2b0e0e 87.5%, #2b0e0e);
            background-size: 40px 70px;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Sound Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const SoundEngine = {
            init: () => { if (audioCtx.state === 'suspended') audioCtx.resume(); },
            playTone: (freq, type, duration, vol = 0.1) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            playNoise: (duration) => {
                const bufferSize = audioCtx.sampleRate * duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                noise.connect(gain);
                gain.connect(audioCtx.destination);
                noise.start();
            },
            // éŸ³æ•ˆåº«
            whoosh: () => { // ç ´ç©ºè² (ç™¼å°„æ™‚)
                 SoundEngine.playNoise(0.2);
                 SoundEngine.playTone(800, 'sine', 0.2, 0.05);
            },
            slash: () => { SoundEngine.playNoise(0.3); SoundEngine.playTone(600, 'sawtooth', 0.1, 0.05); },
            block: () => { SoundEngine.playTone(800, 'square', 0.1, 0.1); SoundEngine.playTone(1200, 'sine', 0.3, 0.05); },
            magic: () => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            },
            ultimate: () => {
                SoundEngine.playNoise(1.5);
                SoundEngine.playTone(100, 'sawtooth', 1.0, 0.2);
                setTimeout(() => SoundEngine.playTone(50, 'square', 1.0, 0.2), 100);
            }
        };

        // --- Data & Optimization ---
        const optimize = (url, width = 500) => `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=${width}&output=webp&q=75`;

        const COVER_IMAGE = optimize("https://imgtolinkx.com/i/ZmetzPkT", 600);

        const CHARACTERS = [
            { id: 'rengoku', name: 'ç…‰ç„ æå£½éƒ', title: 'ç‚æŸ±', role: 'Slayer', color: 'bg-orange-600', hp_max: 1300, element: 'Flame', img: 'https://imgtolinkx.com/i/dIlEEyjS' },
            { id: 'giyu', name: 'å¯Œå²¡ ç¾©å‹‡', title: 'æ°´æŸ±', role: 'Slayer', color: 'bg-blue-600', hp_max: 1200, element: 'Water', img: 'https://imgtolinkx.com/i/2OGqcp85' },
            { id: 'muichiro', name: 'æ™‚é€ ç„¡ä¸€éƒ', title: 'éœæŸ±', role: 'Slayer', color: 'bg-teal-400', hp_max: 1000, element: 'Mist', img: 'https://imgtolinkx.com/i/1Q8IEChJ' },
            { id: 'shinobu', name: 'èƒ¡è¶ å¿', title: 'èŸ²æŸ±', role: 'Slayer', color: 'bg-purple-500', hp_max: 900, element: 'Poison', img: 'https://imgtolinkx.com/i/cxBQPSbf' },
            { id: 'tanjiro', name: 'ç«ˆé–€ ç‚­æ²»éƒ', title: 'æ—¥ä¹‹å‘¼å¸', role: 'Slayer', color: 'bg-red-700', hp_max: 1250, element: 'Sun', img: 'https://imgtolinkx.com/i/uemH1kNX' },
            { id: 'zenitsu', name: 'æˆ‘å¦» å–„é€¸', title: 'é›·ä¹‹å‘¼å¸', role: 'Slayer', color: 'bg-yellow-500', hp_max: 1100, element: 'Thunder', img: 'https://imgtolinkx.com/i/6ORGIjDh' },
            { id: 'kokushibo', name: 'é»‘æ­»ç‰Ÿ', title: 'ä¸Šå¼¦ä¹‹å£¹', role: 'UpperMoon', color: 'bg-red-900', hp_max: 1800, element: 'Moon', img: 'https://imgtolinkx.com/i/hsmEAMsS' },
            { id: 'akaza', name: 'çŒ—çª©åº§', title: 'ä¸Šå¼¦ä¹‹åƒ', role: 'UpperMoon', color: 'bg-pink-600', hp_max: 1600, element: 'Martial', img: 'https://imgtolinkx.com/i/pclB42LQ' },
            { id: 'muzan', name: 'é¬¼èˆè¾» ç„¡æ…˜', title: 'é¬¼ç‹', role: 'Hidden', color: 'bg-gray-900', hp_max: 2500, element: 'Darkness', img: 'https://imgtolinkx.com/i/xMTvN0Wz' }
        ].map(char => ({ ...char, optimizedImg: optimize(char.img, 500) }));

        const FLAVOR_TEXTS = {
            attack: ["{attacker} ç™¼å‹•äº†è¿…é›·ä¸åŠæ©è€³çš„æ”»å‹¢ï¼", "{attacker} çš„åˆ€åˆƒåŠƒç ´äº†ç©ºæ°£ï¼", "ã€Œå…¨é›†ä¸­ï¼ã€{attacker} å‘¼å¸æ€¥ä¿ƒï¼Œç¬é–“æ‹‰è¿‘äº†è·é›¢ï¼", "{attacker} è¸åœ°ç–¾é¦³ï¼Œçœ¼ç¥éŠ³åˆ©å¦‚é·¹ï¼"],
            defense: ["{attacker} æ¶èµ·é˜²ç¦¦å§¿æ…‹ï¼Œæ“‹ä¸‹äº†æ”»æ“Šã€‚", "é—é˜ä¸€è²ï¼{attacker} ç²¾æº–åœ°å½ˆé–‹äº†å°æ‰‹çš„æ‹›å¼ã€‚", "{attacker} å´èº«é–ƒé¿ï¼Œåªå—åˆ°äº†è¼•å¾®æ“¦å‚·ã€‚", "å„˜ç®¡å—å‚·ï¼Œ{attacker} çš„é¬¥å¿—ä¾ç„¶é«˜æ˜‚ï¼"],
            ultimate: ["ã€Œå¥§ç¾©ï¼ã€{attacker} ç‡ƒç‡’äº†ç”Ÿå‘½ï¼Œé‡‹æ”¾å‡ºæ¯€å¤©æ»…åœ°çš„ä¸€æ“Šï¼", "ç©ºæ°£å‡çµ... {attacker} å±•ç¾äº†çœŸæ­£çš„å¯¦åŠ›ï¼", "é€™ä¸€æ“Šï¼Œè²«ç©¿äº† {defender} çš„é˜²ç¦¦ï¼", "ä¼´éš¨è‘—éœ‡è€³æ¬²è¾çš„è½Ÿé³´ï¼Œ{attacker} ä½¿å‡ºäº†çµ•æŠ€ï¼"]
        };

        // --- Components ---

        // æŠ•å°„ç‰©ç‰¹æ•ˆçµ„ä»¶
        const Projectile = ({ type, owner }) => {
            // æ ¹æ“šé¡å‹æ±ºå®šåœ–ç¤º
            const getIcon = () => {
                switch(type) {
                    case 'SLASH': return (
                        <div className="relative w-16 h-16">
                            {/* æ—‹è½‰çš„åˆ€åˆƒ */}
                            <div className="absolute inset-0 text-5xl animate-spin">âš”ï¸</div>
                            {/* åˆ€å…‰æ‹–å°¾ */}
                            <div className="absolute inset-0 bg-white opacity-50 blur-lg rounded-full animate-pulse"></div>
                        </div>
                    );
                    case 'BREATH': return <div className="text-5xl drop-shadow-[0_0_10px_rgba(59,130,246,0.8)]">ğŸŒŠ</div>;
                    case 'ULTIMATE': return <div className="text-7xl drop-shadow-[0_0_20px_rgba(220,38,38,1)]">ğŸ”¥</div>;
                    default: return <div className="text-4xl">âš”ï¸</div>;
                }
            };

            // æ ¹æ“šæ”»æ“Šè€…æ±ºå®šé£›è¡Œæ–¹å‘å‹•ç•« Class
            // æ‰‹æ©Ÿ(Portrait): Playeråœ¨ä¸‹, Enemyåœ¨ä¸Š -> Playeré£›Up, Enemyé£›Down
            // æ¡Œæ©Ÿ(Landscape): Playeråœ¨å·¦, Enemyåœ¨å³ -> Playeré£›Right, Enemyé£›Left
            const animClass = owner === 'PLAYER' 
                ? 'animate-fly-p-mobile md:animate-fly-p-desktop' 
                : 'animate-fly-e-mobile md:animate-fly-e-desktop';

            return (
                <div className={`absolute z-50 pointer-events-none flex items-center justify-center ${animClass}`} style={{ left: '50%', top: '50%', marginTop: '-20px', marginLeft: '-20px' }}>
                    {getIcon()}
                </div>
            );
        };

        const Avatar = ({ char, isPlayer, hasAura, isShaking, hitType }) => {
            const renderEffect = () => {
                if (!isShaking) return null;
                switch (hitType) {
                    case 'SLASH': return <div className="absolute inset-0 bg-white opacity-60 animate-slash z-20 pointer-events-none"></div>;
                    case 'DEFENSE': return <div className="absolute inset-0 border-4 border-yellow-400 rounded-lg animate-block z-20 pointer-events-none bg-yellow-200/20"></div>;
                    case 'BREATH': return <div className="absolute inset-0 bg-gradient-to-r from-blue-400 to-green-400 opacity-50 animate-magic z-20 pointer-events-none mix-blend-screen"></div>;
                    case 'ULTIMATE': return <div className="absolute inset-0 bg-red-600 opacity-60 animate-ultimate z-20 pointer-events-none mix-blend-color-dodge"></div>;
                    default: return <div className="absolute inset-0 bg-white opacity-40 animate-slash z-20 pointer-events-none"></div>;
                }
            };

            return (
                <div className={`relative w-full h-full rounded-lg overflow-hidden border-4 border-double ${isPlayer ? 'border-amber-600' : 'border-red-900'} bg-black bg-opacity-50`}>
                    {hasAura && <div className={`absolute inset-0 opacity-50 animate-pulse-fast ${char.color} blur-xl z-0`}></div>}
                    <img 
                        src={char.optimizedImg} 
                        alt={char.name}
                        loading="eager"
                        className={`absolute inset-0 w-full h-full object-cover object-top z-10 ${isShaking ? 'animate-shake brightness-150' : ''}`}
                    />
                    {renderEffect()}
                </div>
            );
        };

        const BattleCard = ({ char, isPlayer, hp, maxHp, qi, isShaking, isAttacking, hasAura, hitType, projectile }) => {
            const hpPercent = Math.max(0, (hp / maxHp) * 100);
            const qiPercent = Math.min(100, qi);

            return (
                <div className="relative flex flex-col items-center w-[140px] md:w-[180px] z-10">
                    {/* é€™è£¡æ”¾ç½®æŠ•å°„ç‰©ï¼Œå› ç‚ºæ˜¯ absolute positioning based on center of card */}
                    {projectile && <Projectile type={projectile.type} owner={projectile.owner} />}

                    <div className="w-full aspect-[3/4] mb-2 md:mb-3 shadow-2xl relative">
                        <Avatar char={char} isPlayer={isPlayer} hasAura={hasAura} isShaking={isShaking} hitType={hitType} />
                    </div>
                    <div className="w-full space-y-1">
                        <div className="relative h-4 bg-gray-900 rounded-full border border-gray-700 overflow-hidden shadow-lg">
                            <div className="absolute top-0 left-0 h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-500" style={{ width: `${hpPercent}%` }}></div>
                            <span className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md tracking-wider">
                                {hp} / {maxHp}
                            </span>
                        </div>
                        <div className="relative h-2 bg-gray-900 rounded-full border border-gray-700 overflow-hidden">
                            <div className={`absolute top-0 left-0 h-full transition-all duration-500 ${qi >= 100 ? 'bg-yellow-400 animate-pulse' : 'bg-gradient-to-r from-blue-400 to-cyan-300'}`} style={{ width: `${qiPercent}%` }}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const LogWindow = ({ logs }) => {
            const bottomRef = useRef(null);
            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);
            return (
                <div className="w-full h-28 md:h-36 bg-black/60 border-t-2 border-amber-900/50 backdrop-blur-md p-3 overflow-y-auto custom-scrollbar font-serif rounded-t-xl">
                    {logs.map((log, idx) => (
                        <div key={idx} className={`mb-1.5 text-xs md:text-sm border-l-2 pl-2 leading-relaxed ${log.type === 'player' ? 'border-blue-500 text-blue-100' : log.type === 'enemy' ? 'border-red-500 text-red-100' : 'border-yellow-500 text-yellow-100'}`}>
                            {log.text}
                        </div>
                    ))}
                    <div ref={bottomRef} />
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [gameState, setGameState] = useState('MENU');
            const [playerChar, setPlayerChar] = useState(null);
            const [enemyChar, setEnemyChar] = useState(null);
            const [playerHP, setPlayerHP] = useState(0);
            const [enemyHP, setEnemyHP] = useState(0);
            const [playerQi, setPlayerQi] = useState(0);
            const [enemyQi, setEnemyQi] = useState(0);
            const [logs, setLogs] = useState([]);
            const [turnCount, setTurnCount] = useState(0);
            const [loadedCount, setLoadedCount] = useState(0);

            // FX State now includes projectile
            const [fx, setFx] = useState({ 
                pShake: false, eShake: false, 
                hitType: 'SLASH',
                projectile: null // { type: 'SLASH'|'BREATH'|'ULTIMATE', owner: 'PLAYER'|'ENEMY' }
            });
            const [isAnimating, setIsAnimating] = useState(false);

            useEffect(() => {
                const handleLoad = () => setLoadedCount(prev => prev + 1);
                const cover = new Image(); cover.src = COVER_IMAGE; cover.onload = handleLoad; cover.onerror = handleLoad;
                CHARACTERS.forEach(char => {
                    const img = new Image(); img.src = char.optimizedImg; img.onload = handleLoad; img.onerror = handleLoad;
                });
            }, []);

            const loadingProgress = Math.min(100, Math.round((loadedCount / (CHARACTERS.length + 1)) * 100));

            const getRandomText = (type, attacker, defender) => {
                const list = FLAVOR_TEXTS[type];
                return list[Math.floor(Math.random() * list.length)].replace('{attacker}', attacker).replace('{defender}', defender);
            };

            const addLog = (text, type = 'system') => setLogs(prev => [...prev, { text, type }]);

            const startGame = () => { SoundEngine.init(); setGameState('SELECT_PLAYER'); }
            const selectPlayer = (char) => { setPlayerChar(char); setGameState('SELECT_ENEMY'); };
            const selectEnemy = (enemy) => {
                setEnemyChar(enemy); setPlayerHP(playerChar.hp_max); setEnemyHP(enemy.hp_max);
                setPlayerQi(20); setEnemyQi(20); setLogs([{ text: `æˆ°é¬¥é–‹å§‹ï¼${playerChar.name} é­é‡äº† ${enemy.name}ï¼`, type: 'system' }]);
                setTurnCount(1); setFx({ pShake: false, eShake: false, hitType: 'SLASH', projectile: null });
                setIsAnimating(false); setGameState('COMBAT');
            };

            const playImpactSound = (move, multiplier) => {
                if (move === 'ULTIMATE') SoundEngine.ultimate();
                else if (multiplier < 1) SoundEngine.block();
                else if (move === 'BREATH') SoundEngine.magic();
                else SoundEngine.slash();
            };

            // è™•ç†æ”»æ“Šæµç¨‹ï¼šç™¼å°„ -> é£›è¡Œ -> å‘½ä¸­
            const executeAttackSequence = async (attacker, moveType, multiplier, hitType, dmg, setHpFn, currentHp, updateQiFn) => {
                const isPlayer = attacker === 'PLAYER';
                
                // 1. ç™¼å°„æŠ•å°„ç‰© & æ’­æ”¾ç™¼å°„éŸ³æ•ˆ
                SoundEngine.whoosh();
                setFx(prev => ({ ...prev, projectile: { type: moveType, owner: attacker } }));
                
                // 2. ç­‰å¾…é£›è¡Œæ™‚é–“ (0.4s CSS animation)
                await new Promise(r => setTimeout(r, 400));
                
                // 3. ç§»é™¤æŠ•å°„ç‰©ï¼Œè§¸ç™¼å—æ“Šéœ‡å‹• & å‘½ä¸­éŸ³æ•ˆ
                setFx(prev => ({ 
                    ...prev, 
                    projectile: null, 
                    [isPlayer ? 'eShake' : 'pShake']: true, // å°æ–¹éœ‡å‹•
                    hitType: hitType 
                }));
                playImpactSound(moveType, multiplier);

                // 4. æ‰£è¡€ & é¡¯ç¤º Log
                const newHp = Math.max(0, currentHp - dmg);
                setHpFn(newHp);
                
                await new Promise(r => setTimeout(r, 500)); // ç­‰å¾…éœ‡å‹•çµæŸ
                setFx(prev => ({ ...prev, pShake: false, eShake: false }));
                
                return newHp;
            };

            const handleCombat = async (moveType) => {
                if (isAnimating || gameState !== 'COMBAT') return;
                setIsAnimating(true);
                SoundEngine.init();
                
                try {
                    const enemyMoves = ['SLASH', 'DEFENSE', 'BREATH'];
                    const enemyMove = enemyMoves[Math.floor(Math.random() * enemyMoves.length)];
                    let pDmg = 0;
                    let multiplier = 1.0;
                    let currentHitType = 'SLASH';

                    // --- Player Turn ---
                    if (moveType === 'ULTIMATE') {
                        pDmg = 400 + Math.floor(Math.random() * 100);
                        setPlayerQi(0);
                        currentHitType = 'ULTIMATE';
                        addLog(getRandomText('ultimate', playerChar.name, enemyChar.name), 'player');
                    } else {
                        if ((moveType === 'SLASH' && enemyMove === 'BREATH') || 
                            (moveType === 'BREATH' && enemyMove === 'DEFENSE') || 
                            (moveType === 'DEFENSE' && enemyMove === 'SLASH')) {
                            multiplier = 1.5;
                            addLog("ã€å„ªå‹¢ã€‘å£“åˆ¶äº†å°æ‰‹ï¼", 'player');
                        } else if (moveType === enemyMove) {
                            multiplier = 1.0;
                        } else {
                            multiplier = 0.5;
                            addLog("ã€åŠ£å‹¢ã€‘è¢«çœ‹ç©¿äº†...", 'enemy');
                        }

                        if (multiplier < 1) currentHitType = 'DEFENSE';
                        else if (moveType === 'BREATH') currentHitType = 'BREATH';
                        else currentHitType = 'SLASH';

                        pDmg = Math.floor((50 + Math.random() * 20) * multiplier);
                        addLog(getRandomText('attack', playerChar.name, enemyChar.name), 'player');
                    }

                    // åŸ·è¡Œç©å®¶æ”»æ“Š
                    const remainingEnemyHP = await executeAttackSequence('PLAYER', moveType, multiplier, currentHitType, pDmg, setEnemyHP, enemyHP);
                    if(multiplier < 1) addLog("å°æ‰‹é˜²ç¦¦äº†æ”»æ“Šï¼", 'system');
                    else addLog(`${enemyChar.name} å—åˆ° ${pDmg} å‚·å®³`, 'system');

                    if (remainingEnemyHP <= 0) {
                        setTimeout(() => SoundEngine.ultimate(), 500);
                        setGameState('VICTORY');
                        return;
                    }

                    // --- Enemy Turn ---
                    await new Promise(r => setTimeout(r, 300)); // çŸ­æš«åœé “
                    let eDmg = 0;
                    let eMoveType = 'SLASH';
                    let eHitType = 'SLASH';
                    
                    if (enemyQi >= 100) {
                        eDmg = 350 + Math.floor(Math.random() * 100);
                        setEnemyQi(0);
                        eMoveType = 'ULTIMATE';
                        eHitType = 'ULTIMATE';
                        addLog(`ã€è¡€é¬¼è¡“ã€‘${enemyChar.name} é‡‹æ”¾çµ•æŠ€ï¼`, 'enemy');
                    } else {
                        eDmg = 60 + Math.floor(Math.random() * 30);
                        setEnemyQi(prev => Math.min(100, prev + 20));
                        eMoveType = 'SLASH'; // ç°¡å–®åŒ–æ•µäººæ”»æ“Šç‚ºæ–¬æ“Š
                        addLog(getRandomText('attack', enemyChar.name, playerChar.name), 'enemy');
                    }

                    // åŸ·è¡Œæ•µäººæ”»æ“Š
                    const remainingPlayerHP = await executeAttackSequence('ENEMY', eMoveType, 1.0, eHitType, eDmg, setPlayerHP, playerHP);
                    addLog(`${playerChar.name} å—åˆ° ${eDmg} å‚·å®³`, 'system');

                    if (remainingPlayerHP <= 0) {
                        setGameState('DEFEAT');
                        return;
                    }

                    setPlayerQi(prev => Math.min(100, prev + 15));
                    setTurnCount(prev => prev + 1);
                } finally {
                    setIsAnimating(false);
                }
            };

            // --- Render Screens ---
            // (çœç•¥é‡è¤‡çš„ MENU, SELECT_PLAYER, SELECT_ENEMY ç¨‹å¼ç¢¼ï¼Œèˆ‡ä¸Šä¸€ç‰ˆç›¸åŒï¼Œç›´æ¥ä½¿ç”¨)
            if (gameState === 'MENU') {
                return (
                    <div className="min-h-[100dvh] infinity-bg flex flex-col items-center justify-center p-6 relative font-serif text-center">
                        <div className="z-10 animate-float w-full max-w-md">
                            <img src={COVER_IMAGE} alt="é¬¼æ»…ä¹‹åˆƒç„¡é™åŸ" className="w-full h-auto rounded-lg shadow-2xl mb-8 border border-white/20" />
                            <div className="mb-4">
                                <div className="text-gold-accent text-sm mb-1">è³‡æºè¼‰å…¥ä¸­... {loadingProgress}%</div>
                                <div className="w-full h-2 bg-gray-900 rounded-full overflow-hidden border border-gray-700">
                                    <div className="h-full bg-red-600 transition-all duration-300" style={{width: `${loadingProgress}%`}}></div>
                                </div>
                            </div>
                            <button onClick={startGame} disabled={loadingProgress < 100} className={`px-12 py-3 border rounded text-xl font-bold transition-all shadow-[0_0_20px_rgba(220,38,38,0.6)] text-white ${loadingProgress >= 100 ? 'bg-red-900/90 border-red-500 hover:scale-105 cursor-pointer' : 'bg-gray-800 border-gray-600 opacity-50 cursor-not-allowed'}`}>{loadingProgress >= 100 ? 'æ‹”åˆ€ (é–‹å§‹)' : 'æº–å‚™ä¸­...'}</button>
                        </div>
                    </div>
                );
            }
            if (gameState === 'SELECT_PLAYER') {
                const slayers = CHARACTERS.filter(c => c.role === 'Slayer');
                return (
                    <div className="h-[100dvh] infinity-bg p-4 flex flex-col font-serif">
                        <h2 className="text-2xl font-bold text-center mb-4 text-gold-accent mt-2 shrink-0">é¸æ“‡ä½ çš„åŠå£«</h2>
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 pb-4 max-w-5xl mx-auto w-full custom-scrollbar px-1 min-h-0">
                            {slayers.map(char => (
                                <button key={char.id} onClick={() => selectPlayer(char)} className="relative group overflow-hidden rounded-lg border border-gray-700 hover:border-white transition-all bg-black h-auto flex flex-col shadow-lg">
                                    <div className="w-full aspect-[3/5] overflow-hidden relative">
                                        <div className={`absolute inset-0 ${char.color} opacity-20 z-0`}></div>
                                        <img src={char.optimizedImg} alt={char.name} className="absolute inset-0 w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-500 z-10" />
                                        <div className="absolute bottom-0 w-full bg-gradient-to-t from-black via-black/80 to-transparent p-3 pt-10 text-left z-20">
                                            <div className="text-xs text-gray-300 opacity-90 mb-0.5">{char.title}</div>
                                            <div className="text-lg font-bold text-white leading-tight drop-shadow-md">{char.name}</div>
                                            <div className="text-gold-accent font-mono text-[10px] opacity-90 mt-1">HP {char.hp_max}</div>
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setGameState('MENU')} className="mt-4 py-4 text-gray-500 hover:text-white transition-colors shrink-0">è¿”å›æ¨™é¡Œ</button>
                    </div>
                );
            }
            if (gameState === 'SELECT_ENEMY') {
                const enemies = CHARACTERS.filter(c => c.role === 'UpperMoon' || c.role === 'Hidden');
                return (
                    <div className="h-[100dvh] infinity-bg p-4 flex flex-col font-serif">
                        <h2 className="text-2xl font-bold text-center mb-4 text-red-500 mt-2 shrink-0">é¸æ“‡å°æˆ°é¬¼æœˆ</h2>
                        <div className="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 pb-4 max-w-5xl mx-auto w-full custom-scrollbar px-1 min-h-0">
                            {enemies.map(char => (
                                <button key={char.id} onClick={() => selectEnemy(char)} className="relative group overflow-hidden rounded-lg border-2 border-red-900/50 hover:border-red-500 transition-all bg-black/60 h-auto flex flex-col shadow-lg">
                                    <div className="w-full aspect-[2/3] overflow-hidden relative">
                                        <img src={char.optimizedImg} alt={char.name} className="w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-500" />
                                    </div>
                                    <div className="w-full bg-gradient-to-r from-gray-900 to-black p-2 text-left border-t border-red-900/30">
                                        <div className="text-xs text-red-400 mb-0.5">{char.title}</div>
                                        <div className="text-base font-bold text-white leading-tight">{char.name}</div>
                                        <div className="text-red-500 font-mono text-[10px] opacity-70 mt-1">HP {char.hp_max}</div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setGameState('SELECT_PLAYER')} className="mt-4 py-4 text-gray-500 hover:text-white transition-colors shrink-0">è¿”å›ä¸Šä¸€æ­¥</button>
                    </div>
                );
            }
            if (gameState === 'VICTORY' || gameState === 'DEFEAT') {
                return (
                    <div className="h-[100dvh] infinity-bg flex flex-col items-center justify-center p-6 text-center font-serif z-50">
                        <div className="absolute inset-0 bg-black/80"></div>
                        <div className="z-10 animate-float space-y-4">
                            <h2 className={`text-6xl font-black ${gameState === 'VICTORY' ? 'text-yellow-500' : 'text-gray-500'}`}>{gameState === 'VICTORY' ? 'æƒ¡é¬¼æ»…æ®º' : 'æˆ°é¬¥æ•—åŒ—'}</h2>
                            <p className="text-xl text-gray-300">{gameState === 'VICTORY' ? `æ–¬æ®ºäº† ${enemyChar?.name}ï¼` : `${playerChar?.name} å€’ä¸‹äº†...`}</p>
                            <button onClick={() => setGameState('MENU')} className="mt-8 px-8 py-3 bg-gray-800 border border-gray-500 rounded hover:bg-gray-700 text-white">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            }

            // COMBAT UI
            if (!playerChar || !enemyChar) return null;

            return (
                <div className="h-[100dvh] w-full infinity-bg flex flex-col relative font-serif overflow-hidden">
                    <div className="flex-none p-2 flex justify-between items-start z-10 bg-gradient-to-b from-black/80 to-transparent">
                        <div className="text-xs text-gray-400 font-mono bg-black/40 px-2 py-1 rounded">TURN {turnCount}</div>
                        <div className="text-xs px-2 py-1 border border-gray-600 rounded bg-black/50 text-red-200">ç„¡é™åŸ</div>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row items-center justify-center p-2 gap-4 md:gap-16 w-full max-w-6xl mx-auto overflow-y-auto min-h-0 custom-scrollbar">
                        <div className="order-1 md:order-2 shrink-0">
                            <BattleCard 
                                char={enemyChar} 
                                isPlayer={false} 
                                hp={enemyHP} 
                                maxHp={enemyChar.hp_max} 
                                qi={enemyQi} 
                                isShaking={fx.eShake} 
                                hasAura={enemyQi >= 80} 
                                hitType={fx.hitType}
                                projectile={fx.projectile?.owner === 'ENEMY' ? fx.projectile : null}
                            />
                        </div>
                        <div className="hidden md:block order-2 text-5xl font-black text-red-900 opacity-30 italic font-mono select-none shrink-0">VS</div>
                        <div className="order-2 md:order-1 shrink-0">
                            <BattleCard 
                                char={playerChar} 
                                isPlayer={true} 
                                hp={playerHP} 
                                maxHp={playerChar.hp_max} 
                                qi={playerQi} 
                                isShaking={fx.pShake} 
                                hasAura={playerQi >= 100} 
                                hitType={fx.hitType}
                                projectile={fx.projectile?.owner === 'PLAYER' ? fx.projectile : null}
                            />
                        </div>
                    </div>

                    <div className="flex-none z-20 w-full flex flex-col bg-gradient-to-t from-black via-black/95 to-transparent pt-2 pb-6 px-4">
                        <LogWindow logs={logs} />
                        <div className="grid grid-cols-4 gap-2 mt-3 max-w-xl mx-auto w-full">
                            <button disabled={isAnimating} onClick={() => handleCombat('SLASH')} className="bg-blue-900/60 border border-blue-500 p-2 rounded hover:bg-blue-800 disabled:opacity-40 flex flex-col items-center active:scale-95 transition-transform"><span className="text-2xl">ğŸ—¡ï¸</span><span className="text-[10px] mt-1 text-gray-200">æ–¬æ“Š (å‰ª)</span></button>
                            <button disabled={isAnimating} onClick={() => handleCombat('DEFENSE')} className="bg-yellow-900/60 border border-yellow-500 p-2 rounded hover:bg-yellow-800 disabled:opacity-40 flex flex-col items-center active:scale-95 transition-transform"><span className="text-2xl">ğŸ›¡ï¸</span><span className="text-[10px] mt-1 text-gray-200">é˜²ç¦¦ (çŸ³)</span></button>
                            <button disabled={isAnimating} onClick={() => handleCombat('BREATH')} className="bg-green-900/60 border border-green-500 p-2 rounded hover:bg-green-800 disabled:opacity-40 flex flex-col items-center active:scale-95 transition-transform"><span className="text-2xl">ğŸ’¨</span><span className="text-[10px] mt-1 text-gray-200">å‘¼å¸ (å¸ƒ)</span></button>
                            <button disabled={isAnimating || playerQi < 100} onClick={() => handleCombat('ULTIMATE')} className={`relative overflow-hidden p-2 rounded border disabled:opacity-30 flex flex-col items-center justify-center transition-all ${playerQi >= 100 ? 'bg-red-700 border-red-400 animate-pulse scale-105 shadow-[0_0_15px_rgba(220,38,38,0.6)]' : 'bg-gray-800 border-gray-600'}`}><span className="text-2xl">ğŸ”¥</span><span className="text-[10px] font-black mt-1 text-white">å¥§ç¾©</span></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>